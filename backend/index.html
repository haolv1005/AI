<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>AIæµ‹è¯•ç”¨ä¾‹ç”Ÿæˆç³»ç»Ÿ Â· Streamlit é£æ ¼</title>
    <!-- ä½¿ç”¨å›½å†…é•œåƒå¤‡ä»½ï¼Œæé«˜ç¨³å®šæ€§ -->
    <link href="https://cdn.bootcdn.net/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <style>
        .sidebar { transition: transform 0.3s ease; }
        .sidebar-hidden { transform: translateX(-100%); }
        .step-circle { transition: all 0.2s; }
        .modal { transition: opacity 0.2s, visibility 0.2s; }
        .st-card { background-color: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #f0f0f0; padding: 1.25rem; }
        .st-metric { background-color: #f9fafb; border-radius: 0.5rem; padding: 0.75rem; text-align: center; }
        .prose pre { background-color: #f3f4f6; padding: 0.75rem; border-radius: 0.5rem; overflow-x: auto; }
    </style>
</head>
<body class="bg-gray-50 font-sans antialiased">

    <!-- å…¨å±€åŠ è½½é®ç½© -->
    <div id="globalLoading" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-5 rounded-xl shadow-xl flex items-center space-x-3">
            <div class="w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <span class="text-gray-700">å¤„ç†ä¸­...</span>
        </div>
    </div>

    <!-- ä¼šè¯IDéšè—åŸŸ -->
    <input type="hidden" id="sessionId" value="">

    <!-- ä¾§è¾¹æ  / ç§»åŠ¨ç«¯æŠ½å±‰ -->
    <div class="relative min-h-screen flex flex-col md:flex-row">
        <aside id="sidebar" class="sidebar w-full md:w-64 bg-white border-r border-gray-200 p-4 md:min-h-screen md:fixed md:left-0 md:top-0 z-20 md:transform-none transition-transform duration-200 ease-in-out">
            <div class="flex items-center justify-between md:justify-start mb-8">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-flask text-2xl text-blue-500"></i>
                    <span class="text-xl font-bold text-gray-800">AIæµ‹è¯•ç”¨ä¾‹</span>
                </div>
                <button id="closeSidebarBtn" class="md:hidden text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="mb-6 p-3 bg-gray-50 rounded-lg">
                <div class="text-xs text-gray-500 mb-1">å½“å‰ä¼šè¯</div>
                <div id="sessionBadge" class="text-sm font-mono truncate text-gray-700">æœªåˆ›å»º</div>
                <button id="createSessionBtnSidebar" class="mt-2 w-full bg-blue-500 text-white text-sm py-1.5 rounded-md hover:bg-blue-600">
                    <i class="fas fa-plus-circle mr-1"></i>æ–°ä¼šè¯
                </button>
            </div>
            <nav class="space-y-1">
                <button id="navGenerate" class="nav-btn w-full text-left px-4 py-2.5 rounded-lg flex items-center space-x-3 hover:bg-gray-100 transition">
                    <i class="fas fa-file-alt w-5 text-gray-500"></i><span>ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹</span>
                </button>
                <button id="navHistory" class="nav-btn w-full text-left px-4 py-2.5 rounded-lg flex items-center space-x-3 hover:bg-gray-100 transition">
                    <i class="fas fa-history w-5 text-gray-500"></i><span>å†å²è®°å½•</span>
                </button>
                <button id="navKnowledge" class="nav-btn w-full text-left px-4 py-2.5 rounded-lg flex items-center space-x-3 hover:bg-gray-100 transition">
                    <i class="fas fa-database w-5 text-gray-500"></i><span>çŸ¥è¯†åº“ç®¡ç†</span>
                </button>
            </nav>
            <div class="absolute bottom-4 left-4 right-4 text-xs text-gray-400">API v2.1 Â· æœ¬åœ°æ¨¡å‹</div>
        </aside>

        <!-- ç§»åŠ¨ç«¯é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="md:hidden bg-white border-b sticky top-0 z-10 p-3 flex items-center justify-between">
            <button id="openSidebarBtn" class="text-gray-600"><i class="fas fa-bars text-xl"></i></button>
            <div class="flex items-center space-x-2"><i class="fas fa-flask text-blue-500"></i><span class="font-semibold">AIæµ‹è¯•ç”¨ä¾‹</span></div>
            <div class="w-6"></div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main id="mainContent" class="flex-1 md:ml-64 p-4 md:p-6 lg:p-8 bg-gray-50 min-h-screen"></main>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div id="modalOverlay" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 invisible opacity-0">
        <div id="modalContent" class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6"></div>
    </div>

    <script>
        // ---------- å…¨å±€é…ç½® ----------
        // ä½¿ç”¨ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºåŒæºï¼ˆå³å½“å‰IP:ç«¯å£ï¼‰ï¼Œä¾¿äºå±€åŸŸç½‘éƒ¨ç½²
        const API_BASE = '';
        let sessionId = localStorage.getItem('sessionId') || '';
        let currentPage = 'generate';

        function showLoading() { document.getElementById('globalLoading').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('globalLoading').classList.add('hidden'); }

        function updateSessionBadge() {
            const badge = document.getElementById('sessionBadge');
            badge.innerText = sessionId ? sessionId.slice(0,12) + '...' : 'æ— ä¼šè¯';
        }
        updateSessionBadge();

        // æ™®é€š API è¯·æ±‚ï¼ˆæ— è¶…æ—¶ï¼‰
        async function apiFetch(url, options = {}) {
            showLoading();
            try {
                const res = await fetch(url, options);
                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(`HTTP ${res.status}: ${errText.slice(0,100)}`);
                }
                return await res.json();
            } catch (e) {
                console.error(e);
                alert('è¯·æ±‚å¤±è´¥: ' + e.message);
                throw e;
            } finally {
                hideLoading();
            }
        }

        function openModal(htmlContent) {
            document.getElementById('modalContent').innerHTML = htmlContent;
            document.getElementById('modalOverlay').classList.remove('invisible', 'opacity-0');
        }
        function closeModal() {
            document.getElementById('modalOverlay').classList.add('invisible', 'opacity-0');
        }
        document.getElementById('modalOverlay').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        async function createNewSession() {
            try {
                const data = await apiFetch(`${API_BASE}/sessions`, { method: 'POST' });
                sessionId = data.session_id;
                localStorage.setItem('sessionId', sessionId);
                document.getElementById('sessionId').value = sessionId;
                updateSessionBadge();
                alert('æ–°ä¼šè¯å·²åˆ›å»º');
                if (currentPage === 'generate') resetGenerateSteps();
            } catch { alert('åˆ›å»ºä¼šè¯å¤±è´¥'); }
        }

        document.getElementById('openSidebarBtn')?.addEventListener('click', () => document.getElementById('sidebar').classList.remove('sidebar-hidden'));
        document.getElementById('closeSidebarBtn')?.addEventListener('click', () => document.getElementById('sidebar').classList.add('sidebar-hidden'));

        function initNavigation() {
            const navs = { navGenerate: 'generate', navHistory: 'history', navKnowledge: 'knowledge' };
            for (const [btnId, page] of Object.entries(navs)) {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.addEventListener('click', function() {
                        showPage(page);
                        if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('sidebar-hidden');
                        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-gray-100', 'text-blue-600'));
                        this.classList.add('bg-gray-100', 'text-blue-600');
                    });
                }
            }
            document.getElementById('navGenerate')?.classList.add('bg-gray-100', 'text-blue-600');
        }
        document.getElementById('createSessionBtnSidebar')?.addEventListener('click', createNewSession);

        function showPage(page) {
            currentPage = page;
            const main = document.getElementById('mainContent');
            if (page === 'generate') { main.innerHTML = renderGeneratePage(); initGenerateEvents(); }
            else if (page === 'history') { main.innerHTML = renderHistoryPage(); initHistoryEvents(); }
            else if (page === 'knowledge') { main.innerHTML = renderKnowledgePage(); initKnowledgeEvents(); }
        }

        // ========== ç”Ÿæˆé¡µé¢ ==========
        function renderGeneratePage() {
            return `
                <div class="max-w-5xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6 flex items-center"><i class="fas fa-file-alt text-blue-500 mr-3"></i>ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹</h2>
                    <div class="bg-white st-card p-5 mb-6">
                        <div class="flex items-center justify-between">
                            <div class="flex flex-col items-center"><div id="step1Circle" class="step-circle w-10 h-10 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center font-bold">1</div><span class="text-xs mt-1">éœ€æ±‚åˆ†æ</span></div>
                            <div class="flex-1 h-1 mx-2 bg-gray-200"></div>
                            <div class="flex flex-col items-center"><div id="step2Circle" class="step-circle w-10 h-10 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center font-bold">2</div><span class="text-xs mt-1">æµ‹è¯•ç‚¹</span></div>
                            <div class="flex-1 h-1 mx-2 bg-gray-200"></div>
                            <div class="flex flex-col items-center"><div id="step3Circle" class="step-circle w-10 h-10 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center font-bold">3</div><span class="text-xs mt-1">æµ‹è¯•ç”¨ä¾‹</span></div>
                            <div class="flex-1 h-1 mx-2 bg-gray-200"></div>
                            <div class="flex flex-col items-center"><div id="step4Circle" class="step-circle w-10 h-10 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center font-bold">4</div><span class="text-xs mt-1">å¯¼å‡º</span></div>
                        </div>
                    </div>
                    <div id="uploadCard" class="st-card mb-6">
                        <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-blue-400 transition cursor-pointer" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt text-5xl text-gray-400 mb-4"></i>
                            <p class="text-gray-700 text-lg">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ éœ€æ±‚æ–‡æ¡£</p>
                            <p class="text-sm text-gray-500 mt-1">æ”¯æŒ .docx, .pdf</p>
                            <input type="file" id="docFile" accept=".docx,.pdf" class="hidden">
                            <button id="selectFileBtn" class="mt-4 bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 text-sm">é€‰æ‹©æ–‡ä»¶</button>
                        </div>
                    </div>
                    <div id="stepCard" class="st-card hidden">
                        <div class="flex justify-between items-center mb-3">
                            <h3 id="stepTitle" class="text-lg font-semibold"></h3>
                            <div class="space-x-2">
                                <button id="regenerateBtn" class="border px-3 py-1.5 rounded-md text-sm hover:bg-gray-50"><i class="fas fa-sync-alt mr-1"></i>é‡æ–°ç”Ÿæˆ</button>
                                <button id="confirmStepBtn" class="bg-green-500 text-white px-4 py-1.5 rounded-md text-sm hover:bg-green-600">ç¡®è®¤å¹¶ç»§ç»­ <i class="fas fa-arrow-right ml-1"></i></button>
                            </div>
                        </div>
                        <textarea id="stepEditor" rows="12" class="w-full border rounded-lg p-3 font-mono text-sm bg-gray-50 focus:bg-white"></textarea>
                    </div>
                    <div id="exportCard" class="st-card hidden mt-6">
                        <div class="flex items-center justify-between">
                            <div><span class="font-medium">æµ‹è¯•ç”¨ä¾‹å·²ç”Ÿæˆ</span><span id="testCaseStats" class="ml-3 text-sm text-gray-600"></span></div>
                            <div class="flex space-x-3">
                                <button id="exportExcelBtn" class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 flex items-center"><i class="fas fa-file-excel mr-2"></i>å¯¼å‡º Excel</button>
                                <button id="resetWorkflowBtn" class="bg-gray-500 text-white px-5 py-2 rounded-lg hover:bg-gray-600 flex items-center"><i class="fas fa-redo-alt mr-2"></i>é‡æ–°å¼€å§‹</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function resetGenerateSteps() {
            ['step1Circle','step2Circle','step3Circle','step4Circle'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.className = 'step-circle w-10 h-10 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center font-bold';
            });
            document.getElementById('uploadCard')?.classList.remove('hidden');
            document.getElementById('stepCard')?.classList.add('hidden');
            document.getElementById('exportCard')?.classList.add('hidden');
            if (sessionId) {
                try {
                    await apiFetch(`${API_BASE}/sessions/${sessionId}/data`, { method: 'DELETE' });
                } catch (e) {
                    console.warn('æ¸…ç©ºä¼šè¯æ•°æ®å¤±è´¥', e);
                }
            }
            const fileInput = document.getElementById('docFile');
            if (fileInput) fileInput.value = '';
        }

        function initGenerateEvents() {
            const selectBtn = document.getElementById('selectFileBtn');
            const fileInput = document.getElementById('docFile');
            if (selectBtn) selectBtn.addEventListener('click', () => fileInput.click());
            if (fileInput) fileInput.addEventListener('change', handleFileUpload);
            resetGenerateSteps();
        }

        async function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (!sessionId) await createNewSession();
            const formData = new FormData();
            formData.append('file', file);
            let url = `${API_BASE}/upload/document`;
            if (sessionId) url += `?session_id=${sessionId}`;
            try {
                showLoading();
                const res = await fetch(url, { method: 'POST', body: formData });
                const data = await res.json();
                sessionId = data.session_id;
                localStorage.setItem('sessionId', sessionId);
                document.getElementById('sessionId').value = sessionId;
                updateSessionBadge();
                await runStep('summary');
            } catch (err) {
                alert('ä¸Šä¼ å¤±è´¥: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        async function runStep(step) {
            try {
                const data = await apiFetch(`${API_BASE}/generate/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, step: step })
                });
                if (data.status === 'success') {
                    if (step === 'summary') document.getElementById('step1Circle').className = 'step-circle w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-bold';
                    else if (step === 'test_points') document.getElementById('step2Circle').className = 'step-circle w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-bold';
                    else if (step === 'test_cases') {
                        document.getElementById('step3Circle').className = 'step-circle w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-bold';
                        const statsEl = document.getElementById('testCaseStats');
                        if (statsEl && data.result) {
                            const match = data.result.match(/TC-\w+/g);
                            statsEl.innerText = `å…±ç”Ÿæˆ ${match ? match.length : '?'} ä¸ªæµ‹è¯•ç”¨ä¾‹`;
                        }
                    }
                    document.getElementById('uploadCard').classList.add('hidden');
                    document.getElementById('stepCard').classList.remove('hidden');
                    const titleMap = { 'summary': 'ğŸ“‹ éœ€æ±‚æ–‡æ¡£åˆ†ææŠ¥å‘Šï¼ˆå¯ç¼–è¾‘ï¼‰', 'test_points': 'ğŸ” è¯¦ç»†æµ‹è¯•ç‚¹ï¼ˆå¯ç¼–è¾‘ï¼‰', 'test_cases': 'ğŸ¤– æ™ºèƒ½é—®ç­”æµ‹è¯•ç”¨ä¾‹ï¼ˆå¯ç¼–è¾‘ï¼‰' };
                    document.getElementById('stepTitle').innerText = titleMap[step] || step;
                    document.getElementById('stepEditor').value = data.result || 'æ— è¿”å›å†…å®¹';
                    window[`current_${step}`] = data.result;

                    document.getElementById('confirmStepBtn').onclick = function() {
                        const edited = document.getElementById('stepEditor').value;
                        if (step === 'summary') { window.current_summary = edited; runStep('test_points'); }
                        else if (step === 'test_points') { window.current_test_points = edited; runStep('test_cases'); }
                        else if (step === 'test_cases') {
                            window.current_test_cases = edited;
                            document.getElementById('step4Circle').className = 'step-circle w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-bold';
                            document.getElementById('exportCard').classList.remove('hidden');
                        }
                    };
                    document.getElementById('regenerateBtn').onclick = () => runStep(step);
                } else {
                    alert('ç”Ÿæˆå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch { alert('æ‰§è¡Œæ­¥éª¤å¤±è´¥'); }
        }

        document.addEventListener('click', function(e) {
            if (e.target.id === 'exportExcelBtn' || e.target.closest('#exportExcelBtn')) {
                if (!sessionId) return alert('æ— ä¼šè¯');
                window.open(`${API_BASE}/export/excel?session_id=${sessionId}`, '_blank');
                alert('Excel å·²ç”Ÿæˆï¼Œè¯·è‡³å†å²è®°å½•é¡µé¢æäº¤åé¦ˆ');
            }
            if (e.target.id === 'resetWorkflowBtn' || e.target.closest('#resetWorkflowBtn')) {
                resetGenerateSteps();
            }
        });

        // ========== å†å²è®°å½•é¡µé¢ ==========
        function renderHistoryPage() {
            return `
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6 flex items-center"><i class="fas fa-history text-blue-500 mr-3"></i>å†å²è®°å½•</h2>
                    <div class="border-b border-gray-200 mb-4">
                        <div class="flex space-x-6">
                            <button id="tabRecords" class="tab-btn py-2 px-1 border-b-2 border-blue-500 text-blue-600 font-medium">æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆè®°å½•</button>
                            <button id="tabQA" class="tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700">æ™ºèƒ½é—®ç­”è®°å½•</button>
                            <button id="tabFeedback" class="tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700">æµ‹è¯•ç”¨ä¾‹åé¦ˆ</button>
                        </div>
                    </div>
                    <div id="tabContent" class="st-card"></div>
                </div>
            `;
        }

        function initHistoryEvents() {
            loadTabContent('records');
            document.getElementById('tabRecords').addEventListener('click', () => loadTabContent('records'));
            document.getElementById('tabQA').addEventListener('click', () => loadTabContent('qa'));
            document.getElementById('tabFeedback').addEventListener('click', () => loadTabContent('feedback'));
        }

        async function loadTabContent(tab) {
            const container = document.getElementById('tabContent');
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            if (tab === 'records') {
                document.getElementById('tabRecords').classList.add('border-blue-500', 'text-blue-600');
                container.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-pulse mr-2"></i>åŠ è½½ä¸­...</div>';
                await loadRecordsTab(container);
            } else if (tab === 'qa') {
                document.getElementById('tabQA').classList.add('border-blue-500', 'text-blue-600');
                container.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-pulse mr-2"></i>åŠ è½½ä¸­...</div>';
                await loadQATab(container);
            } else if (tab === 'feedback') {
                document.getElementById('tabFeedback').classList.add('border-blue-500', 'text-blue-600');
                container.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-pulse mr-2"></i>åŠ è½½ä¸­...</div>';
                await loadFeedbackTab(container);
            }
        }

        async function loadRecordsTab(container) {
            try {
                const records = await apiFetch(`${API_BASE}/records`);
                if (!records || records.length === 0) {
                    container.innerHTML = '<div class="text-center py-10 text-gray-500">æš‚æ— ç”Ÿæˆè®°å½•</div>';
                    return;
                }
                let html = '<div class="space-y-4">';
                records.forEach(rec => {
                    html += `
                        <div class="border rounded-lg p-4 hover:shadow-md transition">
                            <div class="flex flex-wrap justify-between items-center">
                                <div>
                                    <div class="font-medium">${rec.original_filename || 'æœªçŸ¥æ–‡æ¡£'}</div>
                                    <div class="text-sm text-gray-500 mt-1">ç”Ÿæˆæ—¶é—´: ${rec.created_at}</div>
                                    <div class="text-xs text-gray-400 mt-1">ç”¨ä¾‹æ–‡ä»¶: ${rec.output_filename || 'æœªç”Ÿæˆ'}</div>
                                </div>
                                <div class="flex space-x-2 mt-2 sm:mt-0">
                                    <button onclick="viewRecordDetail(${rec.id})" class="text-blue-600 hover:text-blue-800 text-sm border px-3 py-1 rounded">
                                        <i class="fas fa-eye mr-1"></i>è¯¦æƒ…
                                    </button>
                                    <button onclick="openFeedbackModal(${rec.id}, '${rec.original_filename}', '${rec.output_filename}')" class="text-green-600 hover:text-green-800 text-sm border px-3 py-1 rounded">
                                        <i class="fas fa-star mr-1"></i>åé¦ˆ
                                    </button>
                                    <a href="${API_BASE}/records/${rec.id}/export" class="text-gray-600 hover:text-gray-800 text-sm border px-3 py-1 rounded">
                                        <i class="fas fa-download mr-1"></i>ä¸‹è½½
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = '<div class="text-red-500">åŠ è½½å¤±è´¥</div>';
            }
        }

        window.viewRecordDetail = async function(id) {
            try {
                const rec = await apiFetch(`${API_BASE}/records/${id}`);
                const html = `
                    <h3 class="text-xl font-bold mb-4">è®°å½•è¯¦æƒ…</h3>
                    <div class="space-y-3">
                        <p><span class="font-medium">éœ€æ±‚æ–‡æ¡£:</span> ${rec.original_filename}</p>
                        <p><span class="font-medium">ç”Ÿæˆæ—¶é—´:</span> ${rec.created_at}</p>
                        <p><span class="font-medium">ç”¨ä¾‹æ–‡ä»¶:</span> ${rec.output_filename}</p>
                        <p><span class="font-medium">éœ€æ±‚åˆ†ææ‘˜è¦:</span> <pre class="bg-gray-50 p-2 rounded text-sm mt-1 max-h-60 overflow-auto">${rec.summary || 'æ— '}</pre></p>
                        <p><span class="font-medium">æµ‹è¯•ç‚¹:</span> <pre class="bg-gray-50 p-2 rounded text-sm mt-1 max-h-60 overflow-auto">${rec.requirement_analysis || 'æ— '}</pre></p>
                    </div>
                    <div class="mt-6 flex justify-end"><button onclick="closeModal()" class="bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">å…³é—­</button></div>
                `;
                openModal(html);
            } catch { alert('è·å–è¯¦æƒ…å¤±è´¥'); }
        };

        window.openFeedbackModal = function(recordId, filename, outputName) {
            const html = `
                <h3 class="text-xl font-bold mb-4">ğŸ“ æµ‹è¯•ç”¨ä¾‹åé¦ˆ</h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="bg-gray-50 p-3 rounded">ğŸ“„ éœ€æ±‚æ–‡æ¡£: ${filename}</div>
                        <div class="bg-gray-50 p-3 rounded">ğŸ“Š æµ‹è¯•ç”¨ä¾‹: ${outputName || 'æœªå‘½å'}</div>
                    </div>
                    <div><label class="block text-sm font-medium mb-1">ç”Ÿæˆäºº</label><input type="text" id="feedbackGenerator" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" class="w-full border rounded-lg p-2"></div>
                    <div><label class="block text-sm font-medium mb-1">é‡‡ç”¨ç‡ (%)</label><input type="range" id="feedbackRate" min="0" max="100" value="80" class="w-full" oninput="this.nextElementSibling.innerText = this.value + '%'"><span class="text-sm text-gray-600 ml-2">80%</span></div>
                    <div><label class="block text-sm font-medium mb-1">èŠ‚çº¦æ—¶é—´ (å°æ—¶)</label><input type="number" id="feedbackHours" min="0" step="0.5" value="2.0" class="w-full border rounded-lg p-2"></div>
                    <div><label class="block text-sm font-medium mb-1">é—®é¢˜åé¦ˆ</label><textarea id="feedbackProblem" rows="4" placeholder="è¯·æè¿°é‡åˆ°çš„é—®é¢˜æˆ–æ”¹è¿›å»ºè®®..." class="w-full border rounded-lg p-2"></textarea></div>
                    <div class="flex justify-end space-x-3 mt-4">
                        <button onclick="closeModal()" class="border px-4 py-2 rounded-lg hover:bg-gray-50">å–æ¶ˆ</button>
                        <button onclick="submitFeedback(${recordId})" class="bg-blue-500 text-white px-5 py-2 rounded-lg hover:bg-blue-600">æäº¤åé¦ˆ</button>
                    </div>
                </div>
            `;
            openModal(html);
            setTimeout(() => {
                const rateInput = document.getElementById('feedbackRate');
                if (rateInput) rateInput.addEventListener('input', function() { this.nextElementSibling.innerText = this.value + '%'; });
            }, 100);
        };

        window.submitFeedback = async function(recordId) {
            const name = document.getElementById('feedbackGenerator')?.value.trim();
            if (!name) return alert('è¯·å¡«å†™ç”Ÿæˆäººå§“å');
            const rate = parseInt(document.getElementById('feedbackRate')?.value || 0);
            const hours = parseFloat(document.getElementById('feedbackHours')?.value || 0);
            const problem = document.getElementById('feedbackProblem')?.value || '';
            try {
                await apiFetch(`${API_BASE}/feedback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ record_id: recordId, generator_name: name, adoption_rate: rate, time_saved_hours: hours, problem_feedback: problem })
                });
                alert('åé¦ˆæäº¤æˆåŠŸ');
                closeModal();
            } catch { alert('æäº¤å¤±è´¥'); }
        };

        async function loadQATab(container) {
            try {
                const records = await apiFetch(`${API_BASE}/qa/history?limit=50`);
                if (!records || records.length === 0) {
                    container.innerHTML = '<div class="text-center py-10 text-gray-500">æš‚æ— é—®ç­”è®°å½•</div>';
                    return;
                }
                let html = '<div class="space-y-4">';
                records.forEach(qa => {
                    html += `
                        <div class="border rounded-lg p-4">
                            <div class="flex justify-between">
                                <span class="text-xs text-gray-500">${qa.created_at}</span>
                                <button onclick="deleteQARecord(${qa.id})" class="text-red-500 hover:text-red-700 text-sm"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            <div class="mt-2 font-medium">â“ ${qa.question}</div>
                            <div class="mt-2 text-sm text-gray-700 prose max-w-none">${marked.parse(qa.answer.substring(0,200))}...</div>
                            <div class="mt-2 text-xs text-gray-400">å‚è€ƒæ–‡æ¡£æ•°: ${qa.reference_count || 0}</div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } catch { container.innerHTML = '<div class="text-red-500">åŠ è½½å¤±è´¥</div>'; }
        }

        window.deleteQARecord = async function(id) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥é—®ç­”è®°å½•ï¼Ÿ')) return;
            try {
                await apiFetch(`${API_BASE}/qa/history/${id}`, { method: 'DELETE' });
                loadTabContent('qa');
            } catch { alert('åˆ é™¤å¤±è´¥'); }
        };

        async function loadFeedbackTab(container) {
            try {
                const feedbacks = await apiFetch(`${API_BASE}/feedback`);
                if (!feedbacks || feedbacks.length === 0) {
                    container.innerHTML = `<div class="text-center py-10 text-gray-500">æš‚æ— åé¦ˆè®°å½•</div><div class="mt-4 flex justify-end"><button id="exportFeedbackBtn" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600"><i class="fas fa-download mr-1"></i>å¯¼å‡ºåé¦ˆ</button></div>`;
                    attachExportFeedback();
                    return;
                }
                const total = feedbacks.length;
                const avgRate = (feedbacks.reduce((s, f) => s + (f.adoption_rate || 0), 0) / total).toFixed(1);
                const totalHours = feedbacks.reduce((s, f) => s + (f.time_saved_hours || 0), 0).toFixed(1);
                let html = `<div class="grid grid-cols-3 gap-4 mb-6"><div class="st-metric"><div class="text-2xl font-bold">${total}</div><div class="text-xs text-gray-500">æ€»åé¦ˆæ•°</div></div><div class="st-metric"><div class="text-2xl font-bold">${avgRate}%</div><div class="text-xs text-gray-500">å¹³å‡é‡‡ç”¨ç‡</div></div><div class="st-metric"><div class="text-2xl font-bold">${totalHours}h</div><div class="text-xs text-gray-500">æ€»èŠ‚çº¦æ—¶é—´</div></div></div><div class="space-y-3 max-h-96 overflow-y-auto">`;
                feedbacks.forEach(f => {
                    html += `<div class="border rounded-lg p-3 text-sm"><div class="flex justify-between"><span class="font-medium">${f.requirement_doc || 'æœªçŸ¥æ–‡æ¡£'}</span><span class="text-gray-500">${f.created_at}</span></div><div class="mt-2 grid grid-cols-3 gap-2 text-xs"><span>ç”Ÿæˆäºº: ${f.generator_name || 'æœªå¡«'}</span><span>é‡‡ç”¨ç‡: <span class="font-bold ${f.adoption_rate >= 80 ? 'text-green-600' : f.adoption_rate >= 50 ? 'text-orange-500' : 'text-red-500'}">${f.adoption_rate}%</span></span><span>èŠ‚çº¦: ${f.time_saved_hours || 0}å°æ—¶</span></div>${f.problem_feedback ? `<div class="mt-2 p-2 bg-gray-50 rounded text-gray-700">ğŸ“ ${f.problem_feedback}</div>` : ''}</div>`;
                });
                html += '</div><div class="mt-4 flex justify-end"><button id="exportFeedbackBtn" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600"><i class="fas fa-download mr-1"></i>å¯¼å‡ºåé¦ˆ</button></div>';
                container.innerHTML = html;
                attachExportFeedback();
            } catch { container.innerHTML = '<div class="text-red-500">åŠ è½½å¤±è´¥</div>'; }
        }

        function attachExportFeedback() {
            const btn = document.getElementById('exportFeedbackBtn');
            if (btn) {
                btn.addEventListener('click', function() {
                    const start = prompt('å¼€å§‹æ—¥æœŸ (YYYY-MM-DD)', '2026-01-01');
                    if (!start) return;
                    const end = prompt('ç»“æŸæ—¥æœŸ (YYYY-MM-DD)', new Date().toISOString().slice(0,10));
                    if (!end) return;
                    window.open(`${API_BASE}/feedback/export?start_date=${start}&end_date=${end}`, '_blank');
                });
            }
        }

        // ========== çŸ¥è¯†åº“ç®¡ç†é¡µé¢ ==========
        let selectedRefs = [];

        function renderKnowledgePage() {
            return `
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6 flex items-center"><i class="fas fa-database text-blue-500 mr-3"></i>çŸ¥è¯†åº“ç®¡ç†</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 space-y-6">
                            <div class="st-card">
                                <h3 class="font-medium mb-3 flex items-center"><i class="fas fa-upload mr-2 text-gray-500"></i>ä¸Šä¼ æ–‡ä»¶</h3>
                                <input type="file" id="kbFileInput" accept=".xlsx,.xls,.csv,.txt,.docx,.pdf" class="block w-full text-sm border rounded-lg p-2">
                                <button id="uploadKbBtn" class="mt-3 w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">ä¸Šä¼ å¹¶ç´¢å¼•</button>
                            </div>
                            <div class="st-card">
                                <div class="flex justify-between items-center mb-3"><h3 class="font-medium">æ–‡ä»¶åˆ—è¡¨</h3><button id="rebuildIndexBtn" class="text-xs bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">é‡å»ºç´¢å¼•</button></div>
                                <div id="kbFileList" class="space-y-2 max-h-96 overflow-y-auto"><div class="text-center py-4 text-gray-400"><i class="fas fa-spinner fa-pulse"></i> åŠ è½½ä¸­...</div></div>
                            </div>
                        </div>
                        <div class="lg:col-span-2 space-y-6">
                            <div class="st-card">
                                <h3 class="font-medium mb-3 flex items-center"><i class="fas fa-search mr-2 text-gray-500"></i>çŸ¥è¯†åº“æœç´¢</h3>
                                <div class="flex space-x-2"><input type="text" id="searchQuery" placeholder="è¾“å…¥æœç´¢å…³é”®è¯..." class="flex-1 border rounded-lg p-2"><button id="searchBtn" class="bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">æœç´¢</button></div>
                                <div class="mt-3 flex items-center space-x-3 text-sm">
                                    <label>ç»“æœæ•°é‡:</label><select id="resultLimit" class="border rounded p-1"><option>5</option><option selected>10</option><option>20</option></select>
                                    <label>ç›¸ä¼¼åº¦é˜ˆå€¼(%):</label><input type="number" id="similarityThreshold" min="0" max="100" value="65" class="w-16 border rounded p-1">
                                </div>
                                <div id="searchResultsContainer" class="mt-4 max-h-60 overflow-y-auto border rounded-lg p-2 bg-gray-50"></div>
                            </div>
                            <div class="st-card">
                                <h3 class="font-medium mb-3 flex items-center"><i class="fas fa-robot mr-2 text-gray-500"></i>æ™ºèƒ½é—®ç­”</h3>
                                <textarea id="qaQuestion" rows="3" class="w-full border rounded-lg p-3" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."></textarea>
                                <div class="flex justify-between items-center mt-3">
                                    <span id="selectedRefCount" class="text-sm bg-gray-100 px-3 py-1 rounded-full">å·²é€‰ <span id="selectedCount">0</span> ä¸ªå‚è€ƒ</span>
                                    <button id="askBtn" class="bg-green-500 text-white px-5 py-2 rounded-lg hover:bg-green-600"><i class="fas fa-paper-plane mr-1"></i>æé—®</button>
                                </div>
                                <div id="qaAnswer" class="mt-5 p-4 bg-gray-50 rounded-lg prose max-w-none"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function initKnowledgeEvents() {
            loadKnowledgeFiles();
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            document.getElementById('uploadKbBtn').addEventListener('click', uploadKnowledgeFile);
            document.getElementById('rebuildIndexBtn').addEventListener('click', rebuildIndex);
            document.getElementById('askBtn').addEventListener('click', askQuestion);
        }

        async function loadKnowledgeFiles() {
            try {
                const files = await apiFetch(`${API_BASE}/knowledge/files`);
                const container = document.getElementById('kbFileList');
                if (!files || files.length === 0) { container.innerHTML = '<div class="text-center py-4 text-gray-500">æš‚æ— æ–‡ä»¶</div>'; return; }
                let html = '';
                files.forEach(f => {
                    html += `<div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg"><div class="flex-1 truncate"><span class="text-sm font-medium">${f.filename}</span><span class="text-xs text-gray-500 ml-2">${f.size_str || ''}</span></div><button onclick="deleteKnowledgeFile(${f.id})" class="text-red-500 hover:text-red-700 text-sm ml-2"><i class="fas fa-trash-alt"></i></button></div>`;
                });
                container.innerHTML = html;
            } catch { document.getElementById('kbFileList').innerHTML = '<div class="text-red-500">åŠ è½½å¤±è´¥</div>'; }
        }

        window.deleteKnowledgeFile = async function(fileId) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥æ–‡ä»¶åŠå…¶ç´¢å¼•ï¼Ÿ')) return;
            try {
                await apiFetch(`${API_BASE}/knowledge/files/${fileId}`, { method: 'DELETE' });
                loadKnowledgeFiles();
            } catch { alert('åˆ é™¤å¤±è´¥'); }
        };

        async function uploadKnowledgeFile() {
            const input = document.getElementById('kbFileInput');
            const file = input.files[0];
            if (!file) return alert('è¯·é€‰æ‹©æ–‡ä»¶');
            const formData = new FormData();
            formData.append('file', file);
            try {
                showLoading();
                const res = await fetch(`${API_BASE}/knowledge/upload`, { method: 'POST', body: formData });
                if (res.ok) { alert('ä¸Šä¼ æˆåŠŸ'); input.value = ''; loadKnowledgeFiles(); }
                else alert('ä¸Šä¼ å¤±è´¥');
            } catch { alert('ä¸Šä¼ å¤±è´¥'); } finally { hideLoading(); }
        }

        async function rebuildIndex() {
            try {
                await apiFetch(`${API_BASE}/knowledge/rebuild`, { method: 'POST' });
                alert('ç´¢å¼•é‡å»ºå®Œæˆ');
            } catch { alert('é‡å»ºå¤±è´¥'); }
        }

        async function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) return;
            const limit = document.getElementById('resultLimit').value || 10;
            const threshold = document.getElementById('similarityThreshold').value || 65;
            try {
                const data = await apiFetch(`${API_BASE}/knowledge/search?query=${encodeURIComponent(query)}&limit=${limit}&min_similarity=${threshold}`);
                const resultsDiv = document.getElementById('searchResultsContainer');
                if (!data.results || data.results.length === 0) { resultsDiv.innerHTML = '<div class="text-center py-4 text-gray-500">æ— ç›¸å…³ç»“æœ</div>'; return; }
                let html = '<div class="space-y-2">';
                data.results.forEach(item => {
                    html += `<div class="p-2 border rounded hover:bg-white"><label class="flex items-start space-x-2"><input type="checkbox" class="mt-1 ref-checkbox" data-content="${encodeURIComponent(item.content)}"><div class="flex-1"><div class="text-xs text-gray-500">ç›¸ä¼¼åº¦: ${item.similarity.toFixed(1)}% | ${item.metadata.source || 'æœªçŸ¥'}</div><div class="text-sm truncate">${item.content.substring(0,80)}...</div></div></label></div>`;
                });
                html += '</div>';
                resultsDiv.innerHTML = html;
                selectedRefs = [];
                document.querySelectorAll('.ref-checkbox').forEach(cb => {
                    cb.addEventListener('change', function(e) {
                        const content = decodeURIComponent(this.dataset.content);
                        if (this.checked) selectedRefs.push(content);
                        else selectedRefs = selectedRefs.filter(c => c !== content);
                        document.getElementById('selectedCount').innerText = selectedRefs.length;
                    });
                });
            } catch { alert('æœç´¢å¤±è´¥'); }
        }

        async function askQuestion() {
            const question = document.getElementById('qaQuestion').value.trim();
            if (!question) return alert('è¯·è¾“å…¥é—®é¢˜');
            const contexts = selectedRefs.length > 0 ? selectedRefs : [];
            try {
                const data = await apiFetch(`${API_BASE}/qa/ask`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: question,
                        contexts: contexts,
                        reference_count: Math.max(1, contexts.length || 10),
                        session_id: sessionId || undefined
                    })
                });
                document.getElementById('qaAnswer').innerHTML = marked.parse(data.answer);
            } catch (e) { alert('æé—®å¤±è´¥'); }
        }

        window.onload = async function() {
            try {
                const health = await fetch(`${API_BASE}/health`).then(r => r.json());
                if (health.status !== 'healthy') alert('åç«¯æœåŠ¡æœªå°±ç»ªï¼Œè¯·å¯åŠ¨ api_server.py');
            } catch { alert('æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ï¼Œè¯·ç¡®è®¤ api_server.py å·²è¿è¡Œåœ¨8000ç«¯å£'); }
            initNavigation();
            showPage('generate');
            if (sessionId) { document.getElementById('sessionId').value = sessionId; updateSessionBadge(); }
        };
    </script>
</body>
</html>